tasks:
- id: canary-size-s-display-model-profile
  objective: |
    Add a `Display` trait implementation for the `ModelProfile` struct in
    `crates/router/src/chooser.rs`. The struct has fields `model: String`,
    `tier: ModelTier`, and `capabilities: Vec<String>`. Display should output
    a compact human-readable format: `"{model} ({tier})"`, e.g.
    `"gemini/gemini-2.5-flash (standard)"`. Add a unit test in the existing
    `#[cfg(test)]` block that constructs a `ModelProfile` and verifies
    `.to_string()` output. This is a single-file, ≤2-edit mechanical change.
    Use `read_file` to read lines 1-60 of `chooser.rs`.
  priority: 10
  status: completed
  depends_on: []
  decomposition_depth: 0
  remediation_depth: 0
  is_remediation: false
- id: canary-size-m-role-preference-derives
  objective: |
    Add `Display`, `PartialEq`, and `Eq` derives/impls for the
    `RolePreference` struct in `crates/router/src/chooser.rs`. The struct
    has `min_tier: ModelTier` and `requires: Vec<String>`. Display format:
    `"min_tier={tier}, requires=[{caps}]"` e.g. `"min_tier=standard,
    requires=[tool_use, code]"`. Derive `PartialEq` and `Eq`. Add 2-3 unit
    tests: (1) Display with capabilities, (2) Display with empty requires,
    (3) PartialEq equality and inequality. This is a 1-file, ~4-edit change.
    Use `read_file` to read lines 60-120 of `chooser.rs`.
  priority: 10
  status: failed
  depends_on: []
  decomposition_depth: 0
  error: 'budget exceeded: token limit exceeded: 80318 / 73590 tokens used'
  outcome_context:
    approach: direct implementation
    obstacle:
      kind: model_limitation
      model: unknown
      error_class: budget_exceeded
    discoveries: []
    recommendation: Try a different implementation approach or simpler plan
    files_explored: []
  remediation_depth: 0
  is_remediation: false
- id: canary-size-l-provider-error-diagnostics
  objective: |
    Extract provider error diagnostics into a new module
    `crates/router/src/provider_diagnostics.rs`. Create a
    `ProviderDiagnostic` struct with fields: `provider: String`,
    `error_code: Option<u16>`, `category: ErrorCategory`, `retryable: bool`,
    `message: String`. Add an `ErrorCategory` enum with variants:
    `RateLimit`, `AuthFailure`, `ModelNotFound`, `ContentFilter`,
    `ServerError`, `Unknown`. Add a `classify_error(provider: &str,
    status: u16, body: &str) -> ProviderDiagnostic` function that maps
    HTTP status codes to categories (429→RateLimit, 401/403→AuthFailure,
    404→ModelNotFound, 500-599→ServerError, etc.). Add the module to
    `crates/router/src/lib.rs`. Add comprehensive unit tests covering all
    status code mappings and edge cases. This is a 2-file, design-required
    change (new module + lib.rs registration).
  priority: 10
  status: completed
  depends_on: []
  decomposition_depth: 0
  remediation_depth: 0
  is_remediation: false
- id: canary-size-xl-router-instrumentation
  objective: |
    Add comprehensive tracing instrumentation to the Router and ModelChooser.
    Changes span 4+ files:
    (1) `crates/router/src/router.rs` — add `tracing::info_span!` to
    `chat()`, `chat_with_tools()`, and `resize_budget()` with fields for
    model, role, token count, cost, latency_ms.
    (2) `crates/router/src/chooser.rs` — add `tracing::debug!` to
    `choose_for_role()` logging candidate models, selected model, and
    rejection reasons.
    (3) `crates/router/src/budget.rs` — add `tracing::info!` to `record()`
    logging cumulative spend vs limit, and `tracing::warn!` when remaining
    budget drops below 20%.
    (4) `crates/router/src/lib.rs` — re-export a new `RouterMetrics` struct
    that aggregates call count, total tokens, total cost, average latency.
    (5) Add unit tests for `RouterMetrics` in a new test module.
    This is an XL task (5 files, cross-cutting concern) and SHOULD be
    decomposed by the triage agent into smaller sub-tasks.
  priority: 10
  status: completed
  depends_on: []
  decomposition_depth: 0
  remediation_depth: 0
  is_remediation: false
- id: add-model-profile-display-part1
  objective: Implement the `Display` trait for the `ModelProfile` struct.
  priority: 50
  status: failed
  depends_on: []
  decomposition_depth: 1
  error: 'budget exceeded: token limit exceeded: 75028 / 65000 tokens used'
  outcome_context:
    approach: direct implementation
    obstacle:
      kind: model_limitation
      model: unknown
      error_class: budget_exceeded
    discoveries: []
    recommendation: Try a different implementation approach or simpler plan
    files_explored: []
  remediation_depth: 0
  is_remediation: false
  files_hint:
  - crates/router/src/chooser.rs
- id: add-model-profile-display-part2
  objective: Add a unit test for the `ModelProfile` Display implementation.
  priority: 50
  status: pending
  depends_on:
  - add-model-profile-display-part1
  decomposition_depth: 1
  remediation_depth: 0
  is_remediation: false
  files_hint:
  - crates/router/src/chooser.rs
- id: extract-provider-error-diagnostics-part1
  objective: Create the new module file `crates/router/src/provider_diagnostics.rs` and define the `ProviderDiagnostic` struct and `ErrorCategory` enum.
  priority: 50
  status: completed
  depends_on: []
  decomposition_depth: 1
  pr_url: https://github.com/kitplummer/glitchlab/pull/65
  remediation_depth: 0
  is_remediation: false
  files_hint:
  - crates/router/src/provider_diagnostics.rs
- id: extract-provider-error-diagnostics-part2
  objective: Implement the `classify_error` function in `crates/router/src/provider_diagnostics.rs`, mapping HTTP status codes to `ErrorCategory` and setting `retryable` status.
  priority: 50
  status: completed
  depends_on:
  - extract-provider-error-diagnostics-part1
  decomposition_depth: 1
  pr_url: https://github.com/kitplummer/glitchlab/pull/66
  remediation_depth: 0
  is_remediation: false
  files_hint:
  - crates/router/src/provider_diagnostics.rs
- id: extract-provider-error-diagnostics-part3
  objective: Register the new `provider_diagnostics` module in `crates/router/src/lib.rs` and add comprehensive unit tests for the `classify_error` function in `crates/router/src/provider_diagnostics.rs`.
  priority: 50
  status: completed
  depends_on:
  - extract-provider-error-diagnostics-part2
  decomposition_depth: 1
  pr_url: https://github.com/kitplummer/glitchlab/pull/73
  remediation_depth: 0
  is_remediation: false
  files_hint:
  - crates/router/src/lib.rs
  - crates/router/src/provider_diagnostics.rs
- id: add-router-tracing-part1-setup-and-metrics-struct
  objective: Add `tracing` dependency to `glitchlab-router`'s `Cargo.toml` and define the `RouterMetrics` struct in `router.rs` to aggregate call count, total tokens, total cost, and average latency.
  priority: 50
  status: failed
  depends_on: []
  decomposition_depth: 1
  error: 'budget exceeded: token limit exceeded: 73559 / 65000 tokens used'
  outcome_context:
    approach: direct implementation
    obstacle:
      kind: model_limitation
      model: unknown
      error_class: budget_exceeded
    discoveries: []
    recommendation: Try a different implementation approach or simpler plan
    files_explored: []
  remediation_depth: 0
  is_remediation: false
  files_hint:
  - crates/router/Cargo.toml
  - crates/router/src/router.rs
- id: add-router-tracing-part2-integrate-metrics-and-router-spans
  objective: Integrate `RouterMetrics` into the `Router` struct, initialize it, update its values within the `Router::complete` method, and add a `tracing::info_span!` inside `Router::complete` to log model, role, token count, cost, and latency_ms.
  priority: 50
  status: pending
  depends_on:
  - add-router-tracing-part1-setup-and-metrics-struct
  decomposition_depth: 1
  remediation_depth: 0
  is_remediation: false
  files_hint:
  - crates/router/src/router.rs
- id: add-router-tracing-part3-instrument-model-chooser
  objective: Add `tracing::debug!` statements to `ModelChooser::select` in `chooser.rs` to log candidate models, the selected model, and rejection reasons during the selection process.
  priority: 50
  status: pending
  depends_on:
  - add-router-tracing-part1-setup-and-metrics-struct
  decomposition_depth: 1
  remediation_depth: 0
  is_remediation: false
  files_hint:
  - crates/router/src/chooser.rs
- id: add-router-tracing-part4-reexport-metrics
  objective: Re-export the new `RouterMetrics` struct from `crates/router/src/lib.rs` to make it publicly accessible.
  priority: 50
  status: pending
  depends_on:
  - add-router-tracing-part2-integrate-metrics-and-router-spans
  decomposition_depth: 1
  remediation_depth: 0
  is_remediation: false
  files_hint:
  - crates/router/src/lib.rs
- id: add-router-tracing-part5-test-router-metrics
  objective: Add a new unit test module within `crates/router/src/router.rs` to test the functionality of the `RouterMetrics` struct, ensuring it correctly aggregates data.
  priority: 50
  status: pending
  depends_on:
  - add-router-tracing-part2-integrate-metrics-and-router-spans
  decomposition_depth: 1
  remediation_depth: 0
  is_remediation: false
  files_hint:
  - crates/router/src/router.rs
- id: circuit-fix-0-e72b8892
  objective: Investigate and potentially update the models used in the 'canary-size-m-role-preference-derives' task. Check for any known limitations or parsing errors specific to this model's application.
  priority: 2
  status: failed
  depends_on: []
  decomposition_depth: 0
  error: 'budget exceeded: token limit exceeded: 99997 / 71213 tokens used'
  outcome_context:
    approach: direct implementation
    obstacle:
      kind: model_limitation
      model: unknown
      error_class: budget_exceeded
    discoveries: []
    recommendation: Try a different implementation approach or simpler plan
    files_explored: []
  remediation_depth: 1
  is_remediation: true
- id: circuit-fix-1-45fcb436
  objective: Examine the model integration and parsing logic within the 'add-model-profile-display-part1' task. Address any identified parsing errors or model limitations.
  priority: 2
  status: completed
  depends_on: []
  decomposition_depth: 0
  remediation_depth: 1
  is_remediation: true
- id: circuit-fix-2-7c8e183d
  objective: Review the model's usage and output parsing in the 'add-router-tracing-part1-setup-and-metrics-struct' task. Correct any issues related to model limitations or parsing.
  priority: 2
  status: completed
  depends_on: []
  decomposition_depth: 0
  pr_url: https://github.com/kitplummer/glitchlab/pull/74
  remediation_depth: 1
  is_remediation: true
- id: add-model-profile-display-part1-sub1-define-struct
  objective: Define a new `ModelProfile` data structure to encapsulate model-specific information (e.g., capabilities, cost, latency). Integrate this into the `Provider` trait or related structs in `crates/router`.
  priority: 50
  status: failed
  depends_on: []
  decomposition_depth: 1
  error: 'budget exceeded: token limit exceeded: 65212 / 65000 tokens used'
  outcome_context:
    approach: direct implementation
    obstacle:
      kind: model_limitation
      model: unknown
      error_class: budget_exceeded
    discoveries: []
    recommendation: Try a different implementation approach or simpler plan
    files_explored: []
  remediation_depth: 0
  is_remediation: false
  files_hint:
  - crates/router/src/provider.rs
- id: add-model-profile-display-part1-sub2-implement-retrieval
  objective: Implement the logic to retrieve and populate the `ModelProfile` for each specific LLM provider (Anthropic, Gemini, OpenAI). This will involve adding methods to the respective provider implementations and potentially to the `Router` to aggregate this information.
  priority: 50
  status: pending
  depends_on:
  - add-model-profile-display-part1-sub1-define-struct
  decomposition_depth: 1
  remediation_depth: 0
  is_remediation: false
  files_hint:
  - crates/router/src/provider/anthropic.rs
  - crates/router/src/provider/gemini.rs
  - crates/router/src/provider/openai.rs
  - crates/router/src/router.rs
- id: add-model-profile-display-part1-sub3-integrate-diagnostics
  objective: Modify `crates/router/src/provider_diagnostics.rs` to display the newly retrieved `ModelProfile` information as part of the overall provider diagnostics output.
  priority: 50
  status: pending
  depends_on:
  - add-model-profile-display-part1-sub2-implement-retrieval
  decomposition_depth: 1
  remediation_depth: 0
  is_remediation: false
  files_hint:
  - crates/router/src/provider_diagnostics.rs
